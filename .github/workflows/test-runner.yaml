name: 'Test Runner'

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  test:
    name: 'Test macOS Setup Scripts'
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Make scripts executable
        run: chmod +x src/scripts/*.sh

      - name: Run setup scripts
        run: |
          # Skip pre-install.sh as it installs OS updates and Xcode Command Line Tools,
          # which takes too long in CI and is safe to assume works (Apple-provided commands).
          # GitHub Actions macOS runners already have these installed.
          cd src/scripts
          source utils.sh
          bash organizeHome.sh 2>>"$ERROR_LOG_FILE" || true
          bash cli.sh 2>>"$ERROR_LOG_FILE" || true
          bash media.sh 2>>"$ERROR_LOG_FILE" || true
          bash productivity.sh 2>>"$ERROR_LOG_FILE" || true
          bash dev.sh 2>>"$ERROR_LOG_FILE" || true
          bash security.sh 2>>"$ERROR_LOG_FILE" || true
          zsh shell.sh 2>>"$ERROR_LOG_FILE" || true
          bash post-install.sh 2>>"$ERROR_LOG_FILE" || true

      - name: Check error log
        working-directory: ${{ github.workspace }}
        run: |
          # Filter out expected informational messages and warnings that are normal in CI:
          # - Homebrew installation messages, warnings, and progress indicators
          # - Package already installed warnings (multi-run safe)
          # - chsh authentication failures (expected in CI, can't accept password input)
          # - Network/download progress indicators
          # - Homebrew update messages and analytics notices
          # - Progress bars and status indicators
          ERROR_LOG="setup_errors.log"
          if [[ -f "$ERROR_LOG" ]] && [[ -s "$ERROR_LOG" ]]; then
            FILTERED_LOG=$(mktemp)
            grep -v -E "(^==>|^Warning:|^Note:|^Auto-update|^Updating Homebrew|^==> Downloading|^==> Installing|^==> Pouring|^==> Caveats|^==> Summary|^==> Running|^==> Cleaning|^Already downloaded|^Downloaded|^Installing dependencies|^All formulae are installed|^==> Fetching|^==> Verifying|^==> Extracting|^==> Linking|^==> Creating|^==> Moving|^==> Symlinking|^==> Removing|^==> Purging|^==> Reinstalling|^==> Upgrading|^==> Downgrading|^==> Uninstalling|^==> Searching|^==> Formulae|^==> Casks|^==> Analytics|^==> Services|^==> Taps|^==> Tapping|^Tapped [0-9]+.*formula|^Tapped [0-9]+.*cask|^==> New Formulae|^==> New Casks|^==> Outdated Formulae|^==> Outdated Casks|^You have [0-9]+ outdated|^You can upgrade them with|^or list them with|^==> Homebrew|^We gather less data|^Please reconsider|^Please consider donating|^Updated [0-9]+ taps|^To reinstall|^Cloning into|^Updating files:|^Resolving |^Connecting to |^HTTP request sent|^Length:|^Saving to:|^--[0-9]{4}-[0-9]{2}-[0-9]{2}|^[0-9]{4}-[0-9]{2}-[0-9]{2}.*saved|^[[:space:]]*[0-9]+K|done\.$|^[[:space:]]*100%|^[[:space:]]*[0-9]+\.[0-9]+%|^[[:space:]]*Total|^[[:space:]]*Received|^[[:space:]]*Xferd|^[[:space:]]*Average|^[[:space:]]*Speed|^[[:space:]]*Time|^[[:space:]]*Time|^[[:space:]]*Time|^[[:space:]]*Current|^[[:space:]]*Dload|^[[:space:]]*Upload|^[[:space:]]*Spent|^[[:space:]]*Left|^✔︎ Bottle|^✔︎ Formula|^✔︎ Cask|^rmdir:.*No such file or directory|^Warning:.*is already installed|^Warning:.*Unable to forcibly close|^Warning:.*has been deprecated|^Warning:.*Treating.*as a formula|^Warning:.*These files were overwritten|^Warning:.*For the cask|^Warning:.*To silence this message|^Changing shell for|^Password for|^chsh:.*Credentials could not be verified|^chsh:.*PAM: Authentication failure|^chsh:.*user name or password is invalid|^Password:|^xcode-select: note:|^xcodebuild: note:|^softwareupdate:|^time=.*level=(info|warning)|^time=.*msg=.*starting|^time=.*msg=.*runtime|^time=.*msg=.*creating and starting|^time=.*msg=.*downloading disk image|^#+.*[0-9]+\.[0-9]+%|^#+[[:space:]]*$|^fatal: unable to access.*Could not resolve host)" "$ERROR_LOG" | grep -v '^[[:space:]]*$' > "$FILTERED_LOG" || true

            if [[ -s "$FILTERED_LOG" ]]; then
              echo "❌ Errors found:"
              cat "$FILTERED_LOG"
              rm -f "$FILTERED_LOG"
              exit 1
            fi
            rm -f "$FILTERED_LOG"
          fi

